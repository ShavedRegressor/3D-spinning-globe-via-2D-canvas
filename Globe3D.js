function Globe(t){if(t=t||{},this.size=t.diameter||256,this.textShiftDown=null==t.textShiftDown?.5:t.textShiftDown,this.locations=[],this.dotRadius=3,this.xOffset=t.horizontalMargin||0,this.yOffset=t.verticalMargin||0,this.div="string"==typeof t.div?document.getElementById(t.div):t.div,!this.div)throw t.div?"Element specified for div not found":"Required div property not specified in options";var e=this.size+2*this.xOffset,i=this.size+2*this.yOffset,a='<canvas id="cglobBack" width="'+e+'" height="'+i+'" style="position: absolute; left: 0; top: 3; z-index: 0;"></canvas><canvas id="cglobMid" width="'+e+'" height="'+i+'" style="position: absolute; left: 0; top: 30; z-index: 1;"></canvas>';if(t.shading!==!1&&(a+='<canvas id="cglobShading" width="'+e+'" height="'+i+'" style="position: absolute; left: 0; top: 30; z-index: 2;"></canvas>'),a+='<canvas id="cglobFore" width="'+e+'" height="'+i+'" style="position: absolute; left: 0; top: 30; z-index: 2;"></canvas>',this.div.innerHTML=a,this.canvas=document.getElementById("cglobMid"),this.canvas.removeAttribute("id"),this.canvasUnder=document.getElementById("cglobBack"),this.canvasUnder.removeAttribute("id"),this.canvasOver=document.getElementById("cglobFore"),this.canvasOver.removeAttribute("id"),t.shading){this.canvasShading=document.getElementById("cglobShading");var o=this.size/2;this._drawShading(this.canvasShading,this.xOffset+o,this.yOffset+o,o)}this.g=this.canvas.getContext("2d"),this.g.fillStyle=t.locationColor||"#F00",this.gOver=this.canvasOver?this.canvasOver.getContext("2d"):null,this.gOver&&(this.gOver.fillStyle=t.locationColor||"#F00"),this.overDirty=!1,this.underDirty=!1,this.gUnder=this.canvasUnder?this.canvasUnder.getContext("2d"):null,this.gUnder&&(this.gUnder.fillStyle=t.locationColor||"#F00"),this.globePixels=this.g.getImageData(0,0,this.size,this.size),this.lambertImage="string"==typeof t.image?document.getElementById(t.image):t.image,this.usedImage=null,this.offsets=null,this.offsetRowsStarts=null,this.offsetRowsLengths=null,this.lambertImagePixels=null,this.lambertImageWidth=null,this.lambertImageHeight=null,this.degreesRotation=0;var s=this;this.mouseXlast=null,this.mouseXlastTimeMs=null,this.mouseXlastLast=null,this.mouseXlastLastTimeMs=null,this.mouseDown=!1,this.interactive=t.interactive!==!1;var n=this.canvasOver||this.canvas;Globe.addEvent(n,"mousedown",function(t){s._handleMousedown(t)}),Globe.addEvent(n,"mousemove",function(t){s._handleMousemove(t)}),Globe.addEvent(document,"mouseup",function(t){s._handleMouseup(t)}),this.spinDegreesPerSecond=0,this.spinDegreesFrictionPerSecond=0,this.animFrameRequest=0,this.spinLastFrameUtcMs=null,this.locations=[],this.dotColor=t.locationColor||"#F00",this.expireLocCount=0,this.spinSetCallback=null,this.draw()}function LatLong(t,e,i,a,o){this.latitude=LatLong.parseLatOrLong(t),this.longitude=LatLong.parseLatOrLong(e),this.description=i||"",this.color=a,this.expiration=o,this.isDead=!1,this.details=null}function Point(t,e){this.x=t,this.y=e}Globe.addEvent=function(t,e,i){t.attachEvent?t.attachEvent("on"+e,i):t.addEventListener(e,i,!1)},Globe.prototype._drawShading=function(t,e,i,a){if(t){var o=t.getContext("2d"),s=e-.6*a,n=i-.4*a,r=o.createRadialGradient(s,n,1,s,n,1.8*a);r.addColorStop(0,"rgba(255,255,255,0.12)"),r.addColorStop(.5,"rgba(255,255,255,0)"),r.addColorStop(.7,"rgba(0,0,0,0)"),r.addColorStop(1,"rgba(0,0,0,0.6)"),o.fillStyle=r,o.arc(e,i,a,2*Math.PI,!1),o.fill()}},Globe.prototype.addLocation=function(t,e,i,a,o){var s=null==e?t:new LatLong(t,e,i,a,o);return this.locations.push(s),s.expiration&&this.expireLocCount++,this.spinDegreesPerSecond||this.draw(),s},Globe.prototype.addLocations=function(t){for(var e=0,i=0,a=t.length;a>i;++i)t[i].expiration&&++e;this.locations.length?(this.locations=this.locations.concat(t),this.expireLocCount+=e):(this.locations=t.slice(),this.expireLocCount=e),this.draw()},Globe.prototype.setLocations=function(t){this.locations=[],this.expireLocCount=0,this.addLocations(t)},Globe.prototype.removeLocation=function(t){var e=this.locations.indexOf(t);e>-1&&(this.locations.splice(e,1),t.expiration&&this.expireLocCount--),this.draw()},Globe.prototype.clearLocations=function(){this.locations.splice(0,this.locations.length),this.expireLocCount=0,this.draw()},Globe.prototype.getXYCoordinates=function(t,e){var i,a;"number"==typeof t?(i=t,a=e):(i=t.latitude,a=t.longitude),i=Globe.mod(i,360),i>180&&(i-=360),a=Globe.mod(a-this.degreesRotation,360),a>180&&(a-=360);var o=this.size/2,s=i/180*Math.PI,n=-Math.sin(s)*o+o+this.yOffset,r=a/180*Math.PI,h=Math.abs(Math.cos(s)),l=Math.sin(r),c=l*h*o+o+this.xOffset,d=a>=-90&&90>=a;return{x:c,y:n,foreground:d,xRel:l,latitude:i,longitude:a}},Globe.prototype.getLatLong=function(t,e,i){var a=1-(e-this.yOffset)/(this.size/2);if(-1>a||a>1)return null;var o=Math.asin(a)/Math.PI*180;if(isNaN(o))return null;var s=(t-this.xOffset)/(this.size/2)-1;if(-1>s||s>1)return null;var n=Math.sqrt(1-a*a);if(0>=n||n>1)return null;if(s/=n,-1>s||s>1)return null;var r=Math.asin(s)/Math.PI*180;return r+=this.degreesRotation,r=Globe.mod(r,360),r>180&&(r-=360),isNaN(r)?null:new LatLong(o,r,i)},Globe.prototype.isSpinning=function(){return!!this.spinDegreesPerSecond},Globe.prototype.stop=function(){this.spin()},Globe.prototype.spin=function(t,e){t=t?-t:0,this.spinDegreesPerSecond=t,e?(Globe.differentSign(e,t)&&(e=-e),this.spinDegreesFrictionPerSecond=e):this.spinDegreesFrictionPerSecond=0,this.spinLastFrameUtcMs=(new Date).getTime(),this.draw(),this.spinSetCallback&&this.spinSetCallback(t,this.spinDegreesFrictionPerSecond)},Globe.prototype._updateSpin=function(t){var e=(t-this.spinLastFrameUtcMs)/1e3;if(this.degreesRotation+=this.spinDegreesPerSecond*e,this.spinDegreesFrictionPerSecond){var i=this.spinDegreesFrictionPerSecond*e,a=this.spinDegreesPerSecond-i;Globe.differentSign(a,this.spinDegreesPerSecond)?this.spin(0):this.spinDegreesPerSecond=a}this.degreesRotation%=360,this.spinLastFrameUtcMs=t},Globe.differentSign=function(t,e){return t>0!=e>0},Globe.prototype._handleMousedown=function(t){var e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,a=t.clientY-e.top;this.getLatLong(i,a)&&(this.mouseDown=!0,this.interactive&&this.spin(0),this._handleMousemove(t))},Globe.prototype._handleMousemove=function(t){if(this.interactive&&this.mouseDown&&null!==this.mouseXlast){var e=this.mouseXlast-t.pageX;e*=135/this.size,this.degreesRotation+=e,this.draw()}this.mouseXlastLast=this.mouseXlast,this.mouseXlastLastTimeMs=this.mouseXlastTimeMs,this.mouseXlast=t.pageX,this.mouseXlastTimeMs=(new Date).getTime()},Globe.prototype._handleMouseup=function(t){if(this.mouseDown&&(this.mouseDown=!1,this.interactive&&null!==this.mouseXlastLast&&null!==this.mouseXlastLastTimeMs)){var e=(new Date).getTime()-this.mouseXlastLastTimeMs,i=t.pageX-this.mouseXlastLast;i*=135/this.size;var a=i/(e/1e3);a*=.35,-630>a?a=-630:a>=630&&(a=630),this.spin(a,128)}},Globe.prototype.initialize=function(){var t=this.size,e=this.globePixels.data;this.lambertImageWidth=this.lambertImage&&this.lambertImage.naturalWidth||768,this.lambertImageHeight=this.lambertImage&&this.lambertImage.naturalHeight||256,this.calcOffsets();var i=Globe.getPixels(this.lambertImage,this.lambertImageWidth,this.lambertImageHeight);this.lambertImagePixels=i.data,this.usedImage=i.image;for(var a=t/2,o=0;t>o;++o){var s=o-a;s*=s;for(var n=this.offsets[o],r=o*t*4+3,h=0;t>h;++h){if(isNaN(n[h]))e[r]=0;else{var l=h-a,c=Math.sqrt(s+l*l);if(c>a-1){var d=1-(c-(a-1));e[r]=255*d}else e[r]=255}r+=4}}},Globe.prototype.calcOffsets=function(){for(var t=this.lambertImageWidth,e=this.size,i=[],a=e/2,o=a*a,s=[],n=[],r=0;e>r;++r){for(var h=r-a,l=Math.sqrt(o-h*h),c=a-l,d=(a-c)/a,f=!1,g=[],u=0,b=0,p=t/2,m=0;e>m;++m){var L=1-m/e*2;L/=d;var v=Math.acos(L),y=v/Math.PI*p;g[m]=y,isNaN(y)?f||++u:(f=!0,++b)}i[r]=g,s[r]=u,n[r]=b}this.offsets=i,this.offsetRowsStarts=s,this.offsetRowsLengths=n},Globe.getPixels=function(t,e,i){var a,o;if(t){a=t.naturalWidth,o=t.naturalHeight;try{var s=document.createElement("canvas");s.width=a,s.height=o;var n=s.getContext("2d");return n.drawImage(t,0,0,t.naturalWidth,t.naturalHeight),{image:t,data:n.getImageData(0,0,t.naturalWidth,t.naturalHeight)}}catch(r){console&&(console.error&&console.error(r),console.warn&&console.warn("Could not load image, falling back to vector art"))}}else a=e||256,o=i||128;var h=document.createElement("canvas");h.width=a,h.height=o;var l=h.getContext("2d");return Globe.drawCrudeWorld(l,a,o),{image:h,data:l.getImageData(0,0,a,o)}},Globe.drawCrudeWorld=function(t,e,i){var a="282,0a09b949c95a7afb3ce5a5a9c7eacfbcab7f9fafab9dafaf996070afbf9f9cdfa7adba9fbd95ac8f6f7f8faf9f9ecf8f8f7f8f7f7f8f7fafca72a27696939894b683a7b09194c4909284a090735457756782636468407646675f776a639075588490697c6a518192b5aa95b99a9f967093b28595b584a69ac586598468b7c67dc975778443636a66367c9b6a9b6984474567a5c49bc756b6b86bfbc303085a58186528197a090718|282,781bb78578|282,7c1dc7965387667aad|282,700cb9a638|282,444eb7bd795578|282,4c57b87568|282,9fb598929091737d6b8f7d|282,fac9ac988c7a|282,f7dca4934d8b|282,d1c6807081a5b592b29a9584baa78fad9292af8fadbf9f7f7f4f45726a72584c685a|282,e6d39c94|282,e329b765|282,dc3d7595b5b4939b7c8b5a6a|282,b96c8d7884|282,8dc7736080608090708160808367634c577a4160709270a0b092a4b8d4b89b8bbbbc94a7dbb79077586873b5b7c9965486688b556e9a6a77799b6b6075558abe7b7552776a677b7b7c4b658680d99454b6c3a784989cb8c785a8867686a55a6a7c6c636965b5f3f7faa94ac7f5f8d876c79d84d7e7f7faf8f9d8c6fbf8e9c8b88b7b3a297c4f81d269676a39483ccba87f737d5f695e9f6a837676588ba96caf7f6f3e7e7694776fae9f5f507b8fae9f8fae7cec8a376262606097be70738070787883605a5f6d8f7e7a60708065505856767954856abf8ba7969caa6f4f3f777060706179af9f9fafafc68d7f6f6f6f7f8f9f8f4f9f7c6c8d5f6a78|282,ce866194c095ac6c9c7d7f|282,e494a4bd638563437a5479bf|282,d87292777a|282,d5579c7d73|282,d6497e74|282,d48b80a68f75|282,d66aa46a|ccc,6010d2f6b7b3260908083bf8dbaf|ccc,3e04f7e608|ccc,a706c658|ccc,00fcf8f8f7f7f8f8f8f877b7f9f8b7b6e4b76c8dfaf8f8f5f6f8f8f8f8f8f6c6fac9a9f5f8f7f8e9c7f9f9f9caf81bf8e98a0908080807090808080808080808080808080808080808080808080808080818|038,a2318272a6997aad8f69|038,9684988379|038,452a989778|038,3f22b59a79|038,42288b778496b799897c86788678",o=a.split("|"),s=o.length;t.fillStyle="#038",t.fillRect(0,0,e,i),e/=255,i/=255;for(var n=0;s>n&&999>n;++n){var r=o[n].split(",");t.fillStyle="#"+r[0];var h=r[1],l=(h.length-2)/2;if(l>2){t.beginPath();var c=parseInt(h.substr(0,2),16)*e,d=parseInt(h.substr(2,2),16)*i;t.moveTo(c,d);for(var f=1;l>f;++f)c+=(parseInt(h.substr(2*(f+1),1),16)-8)*e,d+=(parseInt(h.substr(2*(f+1)+1,1),16)-8)*i,t.lineTo(c,d);t.closePath(),t.fill()}}},Globe.mod=function(t,e){return(t%e+e)%e},Globe.fillCircle=function(t,e,i,a,o){var s;o&&(s=t.fillStyle,t.fillStyle=o),t.beginPath(),t.arc(e,i,a,0,2*Math.PI,!0),t.closePath(),t.fill(),o&&(t.fillStyle=s)},Globe.prototype.draw=function(t){if(this.lambertImage&&!this.lambertImage.complete){var e=this;return void setTimeout(function(){e.draw()},100)}if(t=t||(new Date).getTime(),this.spinDegreesPerSecond&&this._updateSpin(t),null===this.offsets&&this.initialize(),this.draw3d(),this.drawLocations(t),(this.expireLocCount||this.spinDegreesPerSecond)&&!this.animFrameRequest){var e=this;this.animFrameRequest=requestAnimationFrame(function(){e.animFrameRequest=0,e.draw()})}},Globe.prototype.draw3d=function(){var t=this.size,e=this.globePixels.data,i=this.lambertImageWidth,a=this.lambertImageHeight/t,o=i/2+(this.degreesRotation+270)/360*i;o=Globe.mod(o,i);for(var s=0,n=this.lambertImagePixels.data,r=this.offsetRowsStarts,h=this.offsetRowsLengths,l=this.offsets,c=0;t>c;++c){var d=r[c],f=d+h[c];s=4*(c*t+d);for(var g=l[c],u=(c*a>>0)*i,b=d;f>b;++b){var p=(o+g[b])%i>>0,m=4*(u+p);e[s]=n[m],e[s+1]=n[m+1],e[s+2]=n[m+2],s+=4}}this.g.putImageData(this.globePixels,this.xOffset,this.yOffset)},Globe.prototype.drawLocations=function(t){this.gOver&&this.overDirty&&(this.gOver.clearRect(0,0,this.canvasOver.width,this.canvasOver.height),this.overDirty=!1),this.gUnder&&this.underDirty&&(this.gUnder.clearRect(0,0,this.canvasUnder.width,this.canvasUnder.height),this.underDirty=!1);for(var e=0,i=0;i<this.locations.length;++i){var a,o,s,n=this.locations[i],r=this.getXYCoordinates(n),h=n.color||this.dotColor,l=1;if(n.expiration){var c=n.expiration-t;if(1e3>c){if(0>=c){n.isDead=!0,e++;continue}l=c/1e3}}if(r.foreground){var d=this.gOver||this.g;d.globalAlpha=l,Globe.fillCircle(d,r.x,r.y,this.dotRadius,h),n.description&&(a=d.measureText(n.description),a.height||(a.height=10),o=r.x+(r.xRel/2-.5)*a.width,s=r.y<this.size/2?r.y-a.height:r.y+a.height,s+=this.textShiftDown*a.height,d.fillStyle=h,d.fillText(n.description,o,s)),this.overDirty=!0}this.gUnder&&(r.foreground||(this.gUnder.globalAlpha=l,Globe.fillCircle(this.gUnder,r.x,r.y,this.dotRadius,h),n.description&&(a=this.gUnder.measureText(n.description),a.height||(a.height=10),o=r.x+(r.xRel/2-.5)*a.width,s=r.y<this.size/2?r.y-a.height:r.y+a.height,s+=this.textShiftDown*a.height,this.gUnder.fillStyle=h,this.gUnder.fillText(n.description,o,s)),this.underDirty=!0))}if(e){for(var f=e,g=this.locations.length-1;f&&g>=0;--g){var u=this.locations[g];u.isDead&&(--f,this.locations.splice(g,1))}this.expireLocCount-=e}},LatLong.prototype.toStringShort=function(){var t=Math.round(LatLong.normalizeLatLong(this.latitude)),e=Math.round(LatLong.normalizeLatLong(this.longitude)),i=t+"° "+e+"°";return this.description&&(i+=": "+this.description),i},LatLong.prototype.toString=function(){var t=LatLong.normalizeLatLong(this.latitude),e=LatLong.normalizeLatLong(this.longitude),i=t+"° "+e+"°";return this.description&&(i+=": "+this.description),i},LatLong.prototype.toStringDmsShort=function(){var t=Math.round(LatLong.normalizeLatLong(this.latitude)),e="lat: "+LatLong.latOrLongToString(t,"N","S");e+=", long: ";var i=Math.round(LatLong.normalizeLatLong(this.longitude));return e+=LatLong.latOrLongToString(i,"E","W"),this.description&&(e+=", Description: "+this.description),e},LatLong.prototype.toStringDms=function(){var t=LatLong.normalizeLatLong(this.latitude),e="latitude: "+LatLong.latOrLongToString(t,"N","S");e+=", longitude: ";var i=LatLong.normalizeLatLong(this.longitude);return e+=LatLong.latOrLongToString(i,"E","W"),this.description&&(e+=", Description: "+this.description),e},LatLong.prototype.toEquirectangular=function(t,e){return new Point(LatLong.longitudeToX_equirectangular(this.longitude,t),LatLong.latitudeToY_equirectangular(this.latitude,e))},LatLong.prototype.normalize=function(){this.latitude=LatLong.normalizeLatLong(this.latitude),this.longitude=LatLong.normalizeLatLong(this.longitude)},LatLong.normalizeLatLong=function(t){return t=(t%360+360)%360,t>180&&(t-=360),t},LatLong.latOrLongToString=function(t,e,i){var a;0>t?(t=-t,a=i):a=e;var o=Math.round(3600*t)/3600,s=Math.floor(o),n=60*(o-s),r=Math.floor(n),h=Math.floor(60*(n-r));return 0===r&&0===h?s+"° "+a:0===h?s+"° "+r+"' "+a:s+"° "+r+"' "+h+'" '+a},LatLong.parseLatOrLong=function(t){if("number"==typeof t)return t;var e=String(t).toLowerCase(),i=e.indexOf("s")>-1||e.indexOf("w")>-1;e=e.replace("/[news° ]/g","");var a=parseFloat(e);return a>0&&i&&(a=-a),a},LatLong.fromEquirectangularCoords=function(t,e,i,a,o){return new LatLong(LatLong.yToLatitude_equirectangular(e,a),LatLong.xToLongitude_equirectangular(t,i),o)},LatLong.latitudeToY_equirectangular=function(t,e){var i=(90-t)/180;return i*e},LatLong.yToLatitude_equirectangular=function(t,e){return 90-t/e*180},LatLong.longitudeToX_equirectangular=function(t,e){var i=(t+180)/360;return i*e},LatLong.xToLongitude_equirectangular=function(t,e){return t/e*360-180};